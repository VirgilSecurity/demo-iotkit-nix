#!/bin/bash

SCRIPT_FOLDER="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

#***************************************************************************************
check_error() {
   RETRIES=$?
   if [ $RETRIES != 0 ]; then
        echo "----------------------------------------------------------------------"
        echo "############# !!! PROCESS ERROR ERRORCODE=[$RETRIES]  #################"
        echo "----------------------------------------------------------------------"
        [ "$1" == "0" ] || exit $RETRIES
   else
        echo "-----# Process OK. ---------------------------------------------------"
   fi
   return $RETRIES
}

#***************************************************************************************

pushd "${SCRIPT_FOLDER}/../../"

#***************************************************************************************
echo "----------------------------------------------------------------------"
echo "############# CHECK WITH PVS-Studio###################################"
echo "----------------------------------------------------------------------"

rm -rf cmake-build-debug
mkdir -p cmake-build-debug
cd ./cmake-build-debug && cmake -DIOTELIC_MCU_BUILD=ON -DCMAKE_EXPORT_COMPILE_COMMANDS=On "../"
pvs-studio-analyzer analyze -o PVS.dat  -j4 \
               -e "../ext"

plog-converter -a GA:1,2 -t errorfile -o PVS.log PVS.dat

PVS_RESULT=$(wc -l  PVS.log |cut -d' ' -f1)

if [ "$PVS_RESULT" -gt "1" ]; then
   tail --lines=+2 PVS.log
   echo "----------------------------------------------------------------------"   
   echo "################# PVS-Studio return: [ERROR]  ########################"
   echo "----------------------------------------------------------------------"
   exit 128
else
   echo "----------------------------------------------------------------------"   
   echo "################# PVS-Studio return: [DONE]  #########################"
   echo "----------------------------------------------------------------------"
fi

exit 0
